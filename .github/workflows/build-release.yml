# Name of the workflow
name: Build Cross-Platform Apps

# This workflow runs when a new "release" is "published" on GitHub
on:
  release:
    types: [published]

# Add workflow-level permissions as well
permissions:
  contents: write

jobs:
  build-apps:
    # Keep job-level permissions for redundancy
    permissions:
      contents: write
    
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Add this so one failure doesn't cancel all other jobs
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y python3-tk
        fi
        python -m pip install --upgrade pip
        pip install pyinstaller

    - name: Build with PyInstaller
      run: pyinstaller --onefile --windowed --name="NEI-MAILER" email_app.py

    - name: Get artifact name
      id: get_name
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          echo "APP_NAME=NEI-MAILER.exe" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=NEI-MAILER-Windows.zip" >> $GITHUB_ENV
          echo "FILE_PATH=dist/NEI-MAILER.exe"
        elif [ "${{ runner.os }}" = "macOS" ]; then
          echo "APP_NAME=NEI-MAILER.app" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=NEI-MAILER-macOS.zip" >> $GITHUB_ENV
          echo "FILE_PATH=dist/NEI-MAILER.app"
        else
          echo "APP_NAME=NEI-MAILER" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=NEI-MAILER-Linux.tar.gz" >> $GITHUB_ENV
          echo "FILE_PATH=dist/NEI-MAILER"
        fi
      shell: bash

    - name: Archive the app
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          7z a ${{ env.ARCHIVE_NAME }} "${{ env.FILE_PATH }}"
        elif [ "${{ runner.os }}" = "macOS" ]; then
          # Use ditto for .app bundling, as zip can break permissions
          ditto -c -k --sequesterRsrc --keepParent "${{ env.FILE_PATH }}" ${{ env.ARCHIVE_NAME }}
        else
          tar -czf ${{ env.ARCHIVE_NAME }} "${{ env.FILE_PATH }}"
        fi

    # Use the modern method for uploading release assets
    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.ARCHIVE_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}