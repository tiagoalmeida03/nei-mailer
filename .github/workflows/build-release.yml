# Name of the workflow
name: Build Cross-Platform Apps

# This workflow runs when a new "release" is "published" on GitHub
on:
  release:
    types: [published]

jobs:
  build-apps:
    permissions:
      contents: write # <-- THIS IS THE FIX
    
    # This job will run on a matrix of different operating systems
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # We'll build for Windows, Ubuntu (Linux), and macOS
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
    # 1. Check out the code from the repository
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Set up the correct Python version
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' # Use a specific Python version

    # 3. Install PyInstaller
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    # 4. Run PyInstaller
    #    --onefile: Creates a single executable file
    #    --windowed: Hides the command-line/terminal window (for GUI apps)
    #    --name: The name of your final app
    - name: Build with PyInstaller
      run: pyinstaller --onefile --windowed --name="NEI MAILER" email_app.py

    # 5. Get the name of the app based on the OS
    - name: Get artifact name
      id: get_name
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          echo "APP_NAME=NEI MAILER.exe" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=NEI-MAILER-Windows.zip" >> $GITHUB_ENV
          echo "FILE_PATH=dist/NEI MAILER.exe" >> $GITHUB_ENV
        elif [ "${{ runner.os }}" = "macOS" ]; then
          echo "APP_NAME=NEI MAILER.app" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=NEI-MAILER-macOS.zip" >> $GITHUB_ENV
          echo "FILE_PATH=dist/NEI MAILER.app" >> $GITHUB_ENV
        else
          echo "APP_NAME=NEI MAILER" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=NEI-MAILER-Linux.tar.gz" >> $GITHUB_ENV
          echo "FILE_PATH=dist/NEI MAILER" >> $GITHUB_ENV
        fi
      shell: bash

    # 6. Create a zip/tar archive of the built app
    - name: Archive the app
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          7z a ${{ env.ARCHIVE_NAME }} "${{ env.FILE_PATH }}"
        elif [ "${{ runner.os }}" = "macOS" ]; then
          zip -r ${{ env.ARCHIVE_NAME }} "${{ env.FILE_PATH }}"
        else
          tar -czf ${{ env.ARCHIVE_NAME }} "${{ env.FILE_PATH }}"
        fi

    # 7. Upload the archive as an asset to the GitHub Release
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # This is the ID of the release that triggered the workflow
        upload_url: ${{ github.event.release.upload_url }}
        # The path to the file to upload
        asset_path: ./${{ env.ARCHIVE_NAME }}
        # The name of the file on the release page
        asset_name: ${{ env.ARCHIVE_NAME }}
        asset_content_type: application/octet-stream